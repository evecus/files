name: 合并并校验 sing-box JSON 规则

on:
  workflow_dispatch:
    inputs:
      urls:
        description: "多个 JSON raw 链接，用英文逗号 , 分隔"
        required: true
      output_name:
        description: "输出文件名（如 merged.json）"
        required: true
        default: merged.json

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl dos2unix

      - name: Download, Validate & Merge
        env:
          URLS: ${{ github.event.inputs.urls }}
          OUTPUT: ${{ github.event.inputs.output_name }}
        run: |
          set -euo pipefail

          WORKDIR="change"
          TMPDIR="$(mktemp -d)"

          mkdir -p "$WORKDIR"

          # 解析逗号分隔 URL
          echo "$URLS" \
            | tr ',' '\n' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
            | sed '/^$/d' \
            | sort -u \
            > "$TMPDIR/urls.txt"

          echo "Parsed URLs:"
          cat "$TMPDIR/urls.txt"

          i=0
          while read -r url; do
            i=$((i+1))
            echo "Downloading [$i]: $url"
            curl -fsSL "$url" -o "$TMPDIR/file_$i.json"

            echo "Validating JSON syntax..."
            jq empty "$TMPDIR/file_$i.json"

            echo "Validating sing-box structure..."
            jq -e '
              .rules
              and (.rules | type == "array")
            ' "$TMPDIR/file_$i.json" > /dev/null
          done < "$TMPDIR/urls.txt"

          echo "Merging rules..."

          jq -s '
            {
              version: 2,
              rules: (
                map(.rules[]?)
                | add
                | to_entries
                | map({
                    ( .key ): (
                      .value
                      | flatten
                      | map(select(type == "string"))
                      | unique
                      | sort
                    )
                  })
              )
            }
          ' "$TMPDIR"/file_*.json > "$WORKDIR/$OUTPUT"

          echo "Final output:"
          jq '.' "$WORKDIR/$OUTPUT"

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          git add change

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: merge & validate sing-box rules"
          git push
